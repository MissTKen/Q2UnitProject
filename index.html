<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Research Sandbox</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#1f2937;       /* gray-800 */
      --text:#e5e7eb;        /* gray-200 */
      --sub:#9ca3af;         /* gray-400 */
      --brand:#60a5fa;       /* blue-400 */
      --accent:#a78bfa;      /* violet-400 */
      --ok:#34d399;          /* emerald-400 */
      --warn:#fbbf24;        /* amber-400 */
      --bad:#f87171;         /* red-400 */
      --chip:#0b1328;        /* dark chip */
      --card:#0b1220;        /* slightly darker */
      --shadow: 0 8px 20px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(96,165,250,.08), transparent),
                  radial-gradient(1200px 600px at 120% 10%, rgba(167,139,250,.08), transparent),
                  var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom:1px solid rgba(148,163,184,.15);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    h1{margin:0; font-size: clamp(20px, 3vw, 32px); letter-spacing:.2px;}
    .subtitle{color:var(--sub); font-size:14px}

    /* Controls */
    .controls{display:grid; grid-template-columns: 1.2fr .8fr .8fr .8fr .6fr; gap:10px; margin-top:14px}
    .control{background:var(--panel); border:1px solid rgba(148,163,184,.15); border-radius: var(--radius); display:flex; align-items:center; padding:8px 10px; gap:8px; box-shadow: var(--shadow)}
    .control input,.control select{flex:1; background:transparent; border:0; color:var(--text); outline:none; font-size:14px}
    .control label{font-size:12px; color:var(--sub)}
    .btn{cursor:pointer; border:1px solid rgba(148,163,184,.2); background:linear-gradient(180deg,#1f2937,#0f172a); color:var(--text); border-radius:var(--radius); padding:10px 12px; font-weight:600; box-shadow: var(--shadow)}
    .btn:hover{border-color: rgba(96,165,250,.5)}
    .btn.brand{background:linear-gradient(180deg,#2563eb,#1d4ed8); border-color:#60a5fa}
    .btn.ghost{background: transparent}

    /* Layout */
    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; margin:16px 0 80px}
    .left{grid-column: span 9}
    .right{grid-column: span 3}

    /* Cards */
    .card{background: linear-gradient(180deg, #0c1222, #0b0f1b); border:1px solid rgba(148,163,184,.15); border-radius: var(--radius); padding:16px; box-shadow: var(--shadow); display:flex; flex-direction:column; gap:10px;}
    .card h3{margin:0; font-size:18px}
    .meta{color:var(--sub); font-size:12px}
    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{background:var(--chip); color:#cbd5e1; border:1px solid rgba(148,163,184,.15); padding:4px 8px; border-radius:999px; font-size:11px}
    .actions{display:flex; gap:8px; margin-top:6px; flex-wrap:wrap}

    /* Sidebar */
    .panel{background:var(--panel); border:1px solid rgba(148,163,184,.15); border-radius: var(--radius); padding:14px; box-shadow: var(--shadow)}
    .panel h4{margin: 0 0 8px 0}
    .small{font-size:12px; color:var(--sub)}
    .list{display:flex; flex-direction:column; gap:10px;}
    .list .row{display:flex; align-items:center; justify-content:space-between; gap:8px}

    /* Modal */
    dialog{border:0; padding:0; border-radius: 16px; width:min(760px, 92vw); background:#0b1220; color:var(--text); box-shadow: var(--shadow)}
    dialog::backdrop{background:rgba(3,7,18,.6); backdrop-filter: blur(4px)}
    .modal-head{padding:16px; border-bottom:1px solid rgba(148,163,184,.15); display:flex; gap:10px; align-items:center; justify-content:space-between}
    .modal-body{padding:16px; max-height: 60vh; overflow:auto}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0a0f1c; border:1px solid rgba(148,163,184,.2); padding:2px 6px; border-radius:6px; font-size:12px}

    /* Footer action bar */
    .dock{position:fixed; bottom:12px; left:50%; transform: translateX(-50%); backdrop-filter: blur(8px); background: rgba(2,6,23,.6); border:1px solid rgba(148,163,184,.2); border-radius:999px; padding:8px; display:flex; gap:8px; z-index:60}

    /* Responsive */
    @media (max-width: 980px){
      .controls{grid-template-columns: 1fr 1fr;}
      .grid{grid-template-columns: 1fr;}
      .left,.right{grid-column: auto}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Student Research Sandbox <span id="dbBadge" style="font-size:12px; color:var(--sub); margin-left:8px"></span></h1>
      <div class="subtitle">Simulated database with safe, pre-vetted sources. Search, filter, preview, and export citations.</div>
      <div class="controls" role="region" aria-label="Search and filters">
        <div class="control" title="Search titles, authors, publications, tags">
          <label for="q">Search</label>
          <input id="q" placeholder="freedom, museum ethics, child soldiers, dignity…" />
        </div>
        <div class="control">
          <label for="topic">Topic</label>
          <select id="topic">
            <option value="">All</option>
            <option>Freedom</option>
            <option>Museum Ethics</option>
            <option>Medical Ethics</option>
            <option>War & Childhood</option>
            <option>Memory & Literature</option>
          </select>
        </div>
        <div class="control">
          <label for="type">Type</label>
          <select id="type">
            <option value="">All</option>
            <option>Article</option>
            <option>Report</option>
            <option>Interview</option>
          </select>
        </div>
        <div class="control">
          <label for="stance">Perspective</label>
          <select id="stance">
            <option value="">Any</option>
            <option>Neutral</option>
            <option>Analytical</option>
            <option>Critical</option>
            <option>Supportive</option>
          </select>
        </div>
        <div class="control">
          <label for="sort">Sort</label>
          <select id="sort">
            <option value="relevance">Relevance</option>
            <option value="newest">Newest</option>
            <option value="reading">Reading Level</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="left" aria-live="polite" aria-busy="false">
        <div id="results" class="results" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:14px;"></div>
      </section>
      <aside class="right">
        <div class="panel">
          <h4>Selected (<span id="selCount">0</span>)</h4>
          <div id="selectedList" class="list small"></div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button id="exportCite" class="btn brand" title="Download MLA citations for selected">Export Citations</button>
            <button id="exportJSON" class="btn ghost" title="Download selected items JSON">Export JSON</button>
          </div>
        </div>
        <div class="panel" style="margin-top:14px;">
          <h4>Tips</h4>
          <div class="small">
            <p>• Click <b>Preview</b> to read an abstract and pull citation details.</p>
            <p>• <b>Open Source</b> opens the linked PDF or a safe placeholder in a new tab.</p>
            <p>• Use the search bar and filters to narrow by topic, type, and perspective.</p>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <div class="dock" role="toolbar" aria-label="Quick actions">
    <button id="reset" class="btn ghost">Reset Filters</button>
    <button id="selectAll" class="btn">Select All Shown</button>
    <button id="clearSel" class="btn">Clear Selection</button>
  </div>

  <dialog id="modal">
    <div class="modal-head">
      <div>
        <div id="mTitle" style="font-weight:700"></div>
        <div id="mMeta" class="small"></div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="copyCite" class="btn">Copy Citation</button>
        <button id="closeModal" class="btn ghost" aria-label="Close (Esc)">Close <span class="kbd">Esc</span></button>
      </div>
    </div>
    <div class="modal-body">
      <p id="mAbstract" style="margin-top:0"></p>
      <div class="chips" id="mChips"></div>
    </div>
  </dialog>

  <script>
  // --- Simulated database ---
  const DB = [
    // Freedom (3)
    {
      id:"FRE-001",
      title:"Understanding Freedom: A Changing Idea",
      authorLast:"Chen", authorFirst:"Maya L.",
      publication:"Civic Studies Review", month:"April", year:2025,
      type:"Article", topic:"Freedom", perspective:"Neutral",
      readingLevel: 8.5, words: 720,
      tags:["rights","equality","opportunity"],
      abstract:"Explains multiple dimensions of freedom—legal rights, social equality, and access to opportunity—showing how definitions evolve with laws, technology, and culture.",
      href:"https://drive.google.com/file/d/1QpV35sgYm4d4cYUdOmaUrC8a-uSWIGZn/view?usp=drive_link"
    },
    {
      id:"FRE-002",
      title:"Internal Freedom: Independence That Exists in the Mind",
      authorLast:"Ortiz", authorFirst:"Samuel",
      publication:"Social Perspectives Quarterly", month:"April", year:2025,
      type:"Article", topic:"Freedom", perspective:"Analytical",
      readingLevel: 8.4, words: 710,
      tags:["identity","resilience","beliefs"],
      abstract:"Defines internal freedom as the ability to maintain identity and dignity despite external limits, with examples from education, community, and psychology.",
      href:"https://drive.google.com/file/d/1HcBu5EOsYgkVwh_t03fnE39Ptc5PbA4x/view?usp=drive_link"
    },
    {
      id:"FRE-003",
      title:"Freedom in Practice: How Access Shapes Real Opportunities",
      authorLast:"Morgan", authorFirst:"Leila",
      publication:"Journal of Public Policy and Equality", month:"May", year:2025,
      type:"Report", topic:"Freedom", perspective:"Critical",
      readingLevel: 8.7, words: 735,
      tags:["opportunity gap","voting","digital divide"],
      abstract:"Investigates gaps between written rights and lived experience across schools, housing, voting, work, and technology; introduces the term ‘practical freedom’.",
      href:"https://drive.google.com/file/d/1DvdXgDXip0oTjcPHB9WnEgj6ROdOWVbt/view?usp=drive_link"
    },

    // Museum / Medical Ethics (3)
    {
      id:"ETH-101",
      title:"Why Museums Display Human Remains: History, Education, and Debate",
      authorLast:"Alvarez", authorFirst:"Nina K.",
      publication:"The Museum Studies Journal", month:"May", year:2025,
      type:"Article", topic:"Museum Ethics", perspective:"Neutral",
      readingLevel: 8.6, words: 710,
      tags:["museums","human remains","repatriation"],
      abstract:"Reviews educational purposes and ethical concerns of displaying human remains; outlines consent, cultural consultation, and repatriation practices.",
      href:"https://drive.google.com/file/d/1pWwCeEWZ4wdPEyNF77lOgCyyWcG9_z1_/view?usp=drive_link"
    },
    {
      id:"ETH-102",
      title:"Medical Curiosity and Human Dignity: The Ethics of Studying Human Remains",
      authorLast:"Patel", authorFirst:"Arjun",
      publication:"Journal of Bioethics and Society", month:"April", year:2025,
      type:"Article", topic:"Medical Ethics", perspective:"Supportive",
      readingLevel: 8.6, words: 705,
      tags:["consent","education","donation"],
      abstract:"Explains consent-based donation programs, respectful handling, and how research and dignity can coexist; addresses legacy collections without consent.",
      href:"https://drive.google.com/file/d/1FxzOcvdvnGShij5RrzaBSW5QkzC53OS7/view?usp=drive_link"
    },
    {
      id:"ETH-103",
      title:"When Are Human Remains Too Sensitive for Display?",
      authorLast:"Ross", authorFirst:"Camille",
      publication:"Public History and Ethics Review", month:"May", year:2025,
      type:"Interview", topic:"Museum Ethics", perspective:"Critical",
      readingLevel: 8.3, words: 700,
      tags:["public reaction","policies","3D models"],
      abstract:"News-style overview of evolving public standards; alternatives like replicas and 3D scans; outlines museum policy shifts and community consultation.",
      href:"https://drive.google.com/file/d/1ba_2Ben3PbSovtZQpvdoevyF0bpTEpOJ/view?usp=drive_link"
    },

    // War & Childhood (3)
    {
      id:"WAR-201",
      title:"How Armed Conflict Affects Children: Identity, Development, and Mental Health",
      authorLast:"Malik", authorFirst:"Rehana",
      publication:"Global Youth & Society Review", month:"May", year:2025,
      type:"Report", topic:"War & Childhood", perspective:"Neutral",
      readingLevel: 8.6, words: 725,
      tags:["trauma","school disruption","displacement"],
      abstract:"Summarizes developmental impacts of conflict: fear responses, role reversal, loss of schooling, and pathways to resilience through stable routines.",
      href:"https://drive.google.com/file/d/1pNaam0LWhlI_F7PzUJE1nC8k2aqXZzml/view?usp=drive_link"
    },
    {
      id:"WAR-202",
      title:"Former Child Soldiers: Life After Conflict",
      authorLast:"Okoro", authorFirst:"Daniel",
      publication:"Human Rights & Conflict Studies Quarterly", month:"April", year:2025,
      type:"Article", topic:"War & Childhood", perspective:"Analytical",
      readingLevel: 8.5, words: 715,
      tags:["rehabilitation","community acceptance","education"],
      abstract:"Explores rehabilitation steps—medical care, counseling, education, vocational skills—and social reintegration challenges and successes.",
      href:"https://drive.google.com/file/d/13HKfDbVVudj0GVb1RbwmA-LDK1R7aeNc/view?usp=drive_link"
    },
    {
      id:"WAR-203",
      title:"Childhood Interrupted: Why War Leaves Lasting Scars on Young Minds",
      authorLast:"Grant", authorFirst:"Melissa",
      publication:"International Security & Youth Journal", month:"May", year:2025,
      type:"Article", topic:"War & Childhood", perspective:"Analytical",
      readingLevel: 8.5, words: 720,
      tags:["experts","trauma recovery","education"],
      abstract:"News-style research article with expert voices explaining how conflict shifts children from exploration to survival, and how support programs rebuild identity.",
      href:"https://drive.google.com/file/d/14gS5dIZ3c3DwuU2WNZ9gyBX1WwH_g5xS/view?usp=drive_link"
    },

    // Memory & Literature (3)
    {
      id:"MEM-301",
      title:"How Literature Preserves the Memory of Forgotten People",
      authorLast:"Harper", authorFirst:"Evelyn",
      publication:"Historical Memory & Culture Review", month:"May", year:2025,
      type:"Article", topic:"Memory & Literature", perspective:"Supportive",
      readingLevel: 8.4, words: 705,
      tags:["erasure","empathy","archives"],
      abstract:"Explains how poems, novels, and creative nonfiction restore presence to those erased from records by combining research with narrative empathy.",
      href:"https://drive.google.com/file/d/1uLo-Ck3EJ8yBJTYT3BRJCMB-6S-WeVnk/view?usp=drive_link"
    },
    {
      id:"MEM-302",
      title:"From Silence to Story: How Art and Writing Reclaim Erased Histories",
      authorLast:"Bennett", authorFirst:"Marcus",
      publication:"Public History & Memory Journal", month:"April", year:2025,
      type:"Report", topic:"Memory & Literature", perspective:"Neutral",
      readingLevel: 8.5, words: 710,
      tags:["community memorials","student research","public art"],
      abstract:"Investigates real-world memorial projects that combine research with creative work to honor unnamed or forgotten individuals in public spaces.",
      href:"https://drive.google.com/file/d/1jeeW0ki0y1BetnMuzJYG2B1xpsAebzoK/view?usp=drive_link"
    },
    {
      id:"MEM-303",
      title:"Can Writing Undo Erasure? The Power and Limits of Literary Memory",
      authorLast:"Sun", authorFirst:"Helena",
      publication:"Journal of Humanities and Remembrance", month:"May", year:2025,
      type:"Article", topic:"Memory & Literature", perspective:"Analytical",
      readingLevel: 8.7, words: 730,
      tags:["limits of imagination","accuracy","museum text"],
      abstract:"Analyzes benefits and risks of literary remembrance; argues for transparency between researched fact and imaginative reconstruction.",
      href:"https://drive.google.com/file/d/1XsBN71lYSIjLcmLfLeVaBEO8n3orrfie/view?usp=drive_link"
    }
  ];

  // --- Self-tests (lightweight diagnostics to prevent silent failures) ---
  (function selfTest(){
    const required = ["id","title","authorLast","authorFirst","publication","month","year","type","topic","perspective","readingLevel","words","tags","abstract","href"];
    const ids = new Set();
    let ok = true; let msgs = [];
    if(DB.length !== 12){ ok=false; msgs.push(`Expected 12 items, found ${DB.length}`); }
    DB.forEach((it, i)=>{
      required.forEach(k=>{ if(!(k in it)) { ok=false; msgs.push(`Item ${i} (${it.id||'no-id'}): missing field ${k}`); } });
      if(ids.has(it.id)){ ok=false; msgs.push(`Duplicate id: ${it.id}`); }
      ids.add(it.id);
    });
    const badge = document.getElementById('dbBadge');
    if(ok){ badge.textContent = `• ${DB.length} sources loaded`; }
    else {
      badge.textContent = `• DB check failed`;
      console.error("DB self-test errors:\n" + msgs.join("\n"));
    }
  })();

  // --- State ---
  let state = { q:"", topic:"", type:"", stance:"", sort:"relevance", selected:new Set() };

  const el = (q)=>document.querySelector(q);
  const resultsEl = el('#results');

  function norm(s){return s.toLowerCase()}

  function scoreItem(it){
    // simple relevance score based on query term appearances
    const terms = state.q.trim().toLowerCase().split(/\s+/).filter(Boolean);
    if(!terms.length) return 1;
    let hay = `${it.title} ${it.authorFirst} ${it.authorLast} ${it.publication} ${it.tags.join(' ')}`.toLowerCase();
    let score = 0;
    for(const t of terms){ if(hay.includes(t)) score += 1; }
    return score + 0.001; // avoid zeros
  }

  function filterSort(){
    let list = DB.filter(it=>
      (!state.topic || it.topic===state.topic) &&
      (!state.type || it.type===state.type) &&
      (!state.stance || it.perspective===state.stance) &&
      (!state.q || scoreItem(it) > 0)
    );

    if(state.sort==='newest') list.sort((a,b)=> (b.year - a.year) || (b.month.localeCompare(a.month)) );
    else if(state.sort==='reading') list.sort((a,b)=> a.readingLevel - b.readingLevel);
    else list.sort((a,b)=> scoreItem(b) - scoreItem(a));

    render(list);
  }

  function render(list){
    resultsEl.innerHTML = '';
    const frag = document.createDocumentFragment();
    list.forEach(it=>{
      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <div style="display:flex; gap:8px; align-items:start; justify-content:space-between">
          <h3>${it.title}</h3>
          <label style="display:flex; gap:6px; align-items:center; font-size:12px">
            <input type="checkbox" ${state.selected.has(it.id)?'checked':''} data-id="${it.id}" class="selbox"/>
            Add
          </label>
        </div>
        <div class="meta">By ${it.authorFirst} ${it.authorLast} — <i>${it.publication}</i>, ${it.month} ${it.year} · ${it.type} · ${it.perspective}</div>
        <p class="small">${it.abstract}</p>
        <div class="chips">${it.tags.map(t=>`<span class="chip">${t}</span>`).join('')}</div>
        <div class="actions">
          <button class="btn" data-act="preview" data-id="${it.id}">Preview</button>
          <button class="btn ghost" data-act="open" data-id="${it.id}">Open Source</button>
        </div>
      `;
      frag.appendChild(card);
    })
    resultsEl.appendChild(frag);
  }

  function updateSelectedUI(){
    el('#selCount').textContent = state.selected.size;
    const lst = el('#selectedList');
    lst.innerHTML='';
    state.selected.forEach(id=>{
      const it = DB.find(x=>x.id===id);
      const row = document.createElement('div');
      row.className='row';
      row.innerHTML = `<span>${it.title}</span><button class="btn ghost" data-remove="${id}">Remove</button>`;
      lst.appendChild(row);
    })
  }

  function mla(it){
    // MLA: Last, First. "Title." Publication, Month Year.
    return `${it.authorLast}, ${it.authorFirst}. "${it.title}." <i>${it.publication}</i>, ${it.month} ${it.year}.`;
  }

  // --- Events ---
  el('#q').addEventListener('input', (e)=>{state.q=e.target.value; filterSort()});
  el('#topic').addEventListener('change', (e)=>{state.topic=e.target.value; filterSort()});
  el('#type').addEventListener('change', (e)=>{state.type=e.target.value; filterSort()});
  el('#stance').addEventListener('change', (e)=>{state.stance=e.target.value; filterSort()});
  el('#sort').addEventListener('change', (e)=>{state.sort=e.target.value; filterSort()});

  resultsEl.addEventListener('click', (e)=>{
    const act = e.target.getAttribute('data-act');
    const id = e.target.getAttribute('data-id');
    if(act){
      const it = DB.find(x=>x.id===id);
      if(act==='preview') openModal(it);
      else if(act==='open'){
        // If a PDF/URL is provided, open it directly; otherwise show a placeholder.
        if(it && it.href && it.href !== 'about:blank'){
          window.open(it.href, '_blank', 'noopener');
        } else {
          const w = window.open('about:blank', '_blank');
          if(w && w.document){
            w.document.write(`<title>${it.title} – Simulated Source</title><body style=\"font-family:system-ui; padding:24px\"><h2>${it.title}</h2><p><em>${it.publication}</em>, ${it.month} ${it.year}</p><hr/><p>This is a simulated external article placeholder for classroom-safe research. Replace <code>href</code> in the database with a real safe URL when ready.</p></body>`);
          }
        }
      }
    }
    if(e.target.classList.contains('selbox')){
      const id2 = e.target.getAttribute('data-id');
      if(e.target.checked) state.selected.add(id2); else state.selected.delete(id2);
      updateSelectedUI();
    }
  });

  el('#selectedList').addEventListener('click', (e)=>{
    const id = e.target.getAttribute('data-remove');
    if(id){ state.selected.delete(id); document.querySelectorAll(`.selbox[data-id="${id}"]`).forEach(cb=>cb.checked=false); updateSelectedUI(); }
  })

  el('#exportCite').addEventListener('click', ()=>{
    const items = Array.from(state.selected).map(id=>DB.find(x=>x.id===id));
    const text = items.map(mla).join("\n\n");
    download(text, 'citations_mla.txt', 'text/plain');
  })

  el('#exportJSON').addEventListener('click', ()=>{
    const items = Array.from(state.selected).map(id=>DB.find(x=>x.id===id));
    download(JSON.stringify(items, null, 2), 'selected_articles.json', 'application/json');
  })

  el('#reset').addEventListener('click', ()=>{
    state={q:"", topic:"", type:"", stance:"", sort:"relevance", selected: state.selected};
    el('#q').value=''; el('#topic').value=''; el('#type').value=''; el('#stance').value=''; el('#sort').value='relevance';
    filterSort();
  })
  el('#selectAll').addEventListener('click', ()=>{
    document.querySelectorAll('#results .selbox').forEach(cb=>{cb.checked=true; state.selected.add(cb.getAttribute('data-id'))});
    updateSelectedUI();
  })
  el('#clearSel').addEventListener('click', ()=>{ state.selected.clear(); document.querySelectorAll('#results .selbox').forEach(cb=>cb.checked=false); updateSelectedUI(); })

  // Modal helpers
  const modal = el('#modal');
  el('#closeModal').addEventListener('click', ()=>modal.close());
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.open) modal.close(); })

  function openModal(it){
    el('#mTitle').innerHTML = it.title;
    el('#mMeta').innerHTML = `By ${it.authorFirst} ${it.authorLast} — <i>${it.publication}</i>, ${it.month} ${it.year} · ${it.type} · ${it.perspective} · RL ${it.readingLevel}`;
    el('#mAbstract').textContent = it.abstract;
    el('#mChips').innerHTML = it.tags.map(t=>`<span class=\"chip\">${t}</span>`).join('');
    modal.showModal();
    el('#copyCite').onclick = ()=>{
      const cite = stripHTML(mla(it));
      navigator.clipboard.writeText(cite).then(()=>{
        el('#copyCite').textContent = 'Copied!'; setTimeout(()=>el('#copyCite').textContent='Copy Citation',1200);
      });
    }
  }

  function stripHTML(s){ const div=document.createElement('div'); div.innerHTML=s; return div.textContent; }

  function download(data, filename, type){
    const blob = new Blob([data], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  // initial render
  filterSort();
  updateSelectedUI();
  </script>
</body>
</html>
